<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="search.css">
</head>
<body>
	<nav class="navbar navbar-expand-lg" id="nav">
		<a class="navbar-brand" href="home.html"><img src="inlook.png" class="img-responsive" alt="brandlogo" id="logoImg"/></a>
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<div class="input-group">
				<input type="text" class="form-control" placeholder="Search..." id="search">
				<span class="input-group-btn">
					<button class="btn btn-default" type="button" id="searchButton"><i class="fas fa-search"></i></button>
				</span>
			</div>
			<ul class="navbar-nav ml-auto">
				<li class="nav-item">
					<a id="userName" class="nav-link" href="profile.html"><i class="fas fa-user-circle"></i>User</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="messages.html"><i class="far fa-envelope fa-lg"></i></a>
				</li>
				|
				<li class="nav-item">
					<a href="login.html" class="nav-link" id="logout"><i class="fas fa-sign-out-alt"></i></a>
				</li>
			</ul>
		</div>
	</nav>
	<h2 id="resultsTitle">Results for<span id="searchFor"><span></h2>
	<div class="error hidden"></div>
	<div id="profileResults"></div>
	<div id="projectResults"></div>
	<div class="profileTemplate hidden">
		<div class="profile col-sm-4">
			<img class="profilePic disabled" src="" height="70px" width="70px">
			<div class="text">
				<h5 class="name"></h5>
				<p id="numProjects"></p>
				<input type="hidden" value="" id="userId"></input>
			</div>
			<i class="far fa-envelope fa-lg" id="message"></i>
		</div>
	</div>
	<div class="projectTemplate hidden">
		<div class="project card col-sm-5">
			<img src="" height="300px" width="100%" class="cardImg"/>
			<div class="card-body">
				<input type="hidden" value="" id="projectId"></input>
				<span class="projectTitle"></span><br>
				<span class="projectOwner"></span>
				<input type="hidden" value="" id="ownerId"></input>
				<i class="far fa-heart fa-lg likeButton" value=""></i>
			</div>
		</div>
	</div>
	<!--Project View Modal -->
	<div class="modal fade" id="projectViewModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLongTitle"></h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div id="project-view-modal" class="modal-body">
					<img src="" alt="Project Image" class="design-pics img-responsive" id="projectImgModal">
					<p id="projectTitleModal"></p>
					<p id="projectOwnerModal"></p>
					<p id="projectDescriptionModal"></p>
				</div>
				<div class="modal-footer">
					<i class="far fa-heart fa-lg likeButton" value=""></i>
				</div>
			</div>
		</div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	<script>
	$(document).ready(()=>{
        const dislikeProjectUrl= '/dislikeProject';
        const likeProjectUrl = '/likeProject';
        let projId;
		const userId = sessionStorage.getItem('id');
		const getUserProfileUrl = '/loadProfile/' + userId;
		$.ajax({
			url: getUserProfileUrl,
			type: 'GET',
			datatype: 'JSON',
			success: (data) => {
				console.log('Recieved user profile info');
				console.log(data);
				$('#userName')[0].childNodes[1].nodeValue = ' ' + data.firstName + ' ' + data.lastName;
				$('.profileName').html(data.firstName + ' ' + data.lastName);
			}
		});

		$('#userName').click(()=>{
			sessionStorage.setItem('profileClickedId',sessionStorage.getItem('id'));
			window.location.href = 'profile.hmtl';
		});
		const searchKey = decodeURIComponent(window.location.search.substr(1));
		const key = decodeURIComponent(window.location.search.substr(9));
		console.log("SEARCH " + searchKey);
		$('#searchFor').html(' "' + key + '"');
		$.ajax({
			url: searchKey,
			type: 'GET',
			datatype: 'JSON',
			success: (data) => {
				if(data.length > 0){
				$('#profileResults').empty();
				$('#projectResults').empty();
				let users = {};
				$(data).each((e)=>{
					if(data[e].projectId){
						let clone = $('.projectTemplate').contents().clone();
						clone.find('img').attr('src',data[e].mainImg);
						clone.find('.projectOwner').html(data[e].firstName + ' ' + data[e].lastName);
						clone.find('.projectTitle').html(data[e].projectTitle);
						clone.find('#ownerId').attr('value',data[e].userId);
						clone.find('#projectId').attr('value',data[e].projectId);
						clone.find('.likeButton').attr('value',data[e].projectId);
						clone.appendTo("#projectResults");
						if(!(data[e].userId in users)){
							users[data[e].userId] = data[e];
						}
					} else {
						if(!(data[e].userId in users)){
							users[data[e].userId] = data[e];
						}
					}
				});
				Object.keys(users).forEach((e)=>{
					if(users[e].firstName.toUpperCase().search(key.toUpperCase()) || users[e].lastName.toUpperCase().search(key.toUpperCase())){
						let clone = $('.profileTemplate').contents().clone();
						clone.find('#userId').attr('value',users[e].userId);
						clone.find('.name').html(users[e].firstName + ' ' + users[e].lastName);
						if(users[e].userId == sessionStorage.getItem('id')){
							clone.find('#message').addClass('hidden');
						}
						if(users[e].profilePicture == null){
							clone.find('.profilePic').attr('src','https://maxcdn.icons8.com/Share/icon/Users//user_male_circle_filled1600.png');
						} else {
							clone.find('.profilePic').attr('src', users[e].profilePicture);
						}
						$('#profileResults').append(clone);
					}
				});
				}
				else {
					$('.error').html("Oops we couldn't find anything!").removeClass("hidden");
				}	
			}
		});
		$('#searchButton').click(()=>{
			window.location.href = 'search.html?/search/' + $('#search').val();
		});
		$('body').on('click','.projectOwner',()=>{
			sessionStorage.setItem('profileClickedId',$(event.target).next().val() );
			window.location.href = '/profile.html';
		});

		$('body').on('click','#message',(e)=>{
			console.log("messages");
			e.stopPropagation();
			let id = $(event.target).next().attr('value');
			sessionStorage.setItem('mostRecentConversation',id);
			window.location.href = 'messages.html';
		});

		$('body').on('click','.profile',()=>{
			console.log(event.target);
		
			let id = $(event.target).find('#userId').attr('value');
			if(!id){
				id = $(event.target).next().children('#userId').attr('value');
			} 
			if(!id){
				id = $(event.target).siblings('#userId').attr('value');
			}

			console.log("ID " + id);
			sessionStorage.setItem('profileClickedId',id);
			window.location.href = '/profile.html';
		});
      
        $('body').on('click', '.likeButton', (event) => {
          console.log(projId);
          if($(event.target).hasClass('fas')){
            $.ajax({
              url: dislikeProjectUrl,
              type: 'POST',
              datatype: 'JSON',
              data: {
                userId: userId,
                projectId: projId
              },
              success: (data) => {
                console.log('disliked');
                $(event.target).removeClass('fas').addClass('far');
              }
            });
            } 
            else {
              $.ajax({
                  url: likeProjectUrl,
                  type: 'POST',
                  datatype: 'JSON',
                  data: {
                      userId: userId,
                      projectId: projId
                  },
                  success: (data) => {
                      //change appearance of like button
                      console.log('Liked');
                      $(event.target).removeClass('far').addClass('fas');
                  }
              });
            }
        });

		$('#projectViewModal').on('hidden.bs.modal',()=>{
			if($('.modal-footer .likeButton').hasClass('fas')){
				$('.card-body .likeButton').removeClass('far').addClass('fas');
			} else {
				$('.card-body .likeButton').removeClass('fas').addClass('far');
			}
		});

		$('body').on('click','.project',()=>{
			projId = $(event.target).find('#projectId').val();
			console.log($(event.target).next().children('#projectOwner'));

			if(!projId){
				projId = $(event.target).next().children('#projectId').val();
			}
			$.ajax({
				url: '/getProject/' + projId,
				type: 'GET',
				datatype: 'JSON',
				success: (data) => {
					console.log("PROJECT DATA " + data[0].projectTitle);
					$('#projectTitleModal').html(data[0].projectTitle);
					$('#projectOwnerModal').html(data[0].firstName + " " + data[0].lastName);
					$('#projectImgModal').attr('src',data[0].mainImg);
					$('#projectDescriptionModal').html(data[0].projectDescription);
                  
                    const isProjectLikedUrl = '/isProjectLiked/' + userId + '/' + projId;
                    $.ajax({
                      url: isProjectLikedUrl,
                      type: 'GET',
                      datatype: 'JSON',
                      success: (data) => {
                        console.log('Checked if disliked or not');
                        //if data exists then project was disliked
                        if (data) {
                          //set appearance of like button to already liked
                          $('#likeButton').removeClass('far').addClass('fas');
                        }
                        else {
                          $('#likeButton').removeClass('fas').addClass('far');
                        }
                        $('#projectViewModal').modal();
                      }
                    });
				}
			});
			if($(event.target).find('.likeButton').hasClass('fas')){
				$('.modal-footer .likeButton').removeClass('far').addClass('fas');
			} else {
				$('modal-footer .likeButton').removeClass('fas').addClass('far');
			}
			
		});
	});
	</script>
</body>
</html>
